<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® æ¸¸æˆæ•°æ®ä»ªè¡¨ç›˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        /* è‡ªå®šä¹‰å­—ä½“å’Œå…¨å±€æ ·å¼ */
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif';
            background-color: #111827; /* Dark background */
            color: #d1d5db; /* Light text */
        }
        
        main {
            min-height: 0; /* å…³é”®ä¿®å¤ï¼Œå…è®¸flex/gridçš„å­é¡¹æ”¶ç¼© */
        }

        /* å®šä¹‰ä»ªè¡¨ç›˜ç½‘æ ¼å¸ƒå±€ - é»˜è®¤ä¸ºå•åˆ— */
        .dashboard-grid {
            display: grid;
            gap: 1rem; /* ç»Ÿä¸€æ‰€æœ‰ç½‘æ ¼é—´è· */
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        /* åœ¨å¤§å±å¹•ï¼ˆlgï¼‰åŠä»¥ä¸Šåº”ç”¨å¤šåˆ—å¸ƒå±€ */
        @media (min-width: 1024px) { /* lg breakpoint */
            .dashboard-grid {
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }
        }
        
        /* ç¡®ä¿å¡ç‰‡åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½æ˜¯flexå¸ƒå±€ */
        .dark-card {
            display: flex;
            flex-direction: column;
        }

        /* å¼ºåˆ¶Canvaså…ƒç´ å¡«æ»¡å…¶çˆ¶å®¹å™¨ï¼Œé˜²æ­¢è£åˆ‡ */
        .flex-grow.relative > canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* å¡ç‰‡æ ·å¼ */
        .dark-card {
            background-color: rgba(31, 41, 55, 0.7);
            color: #f9fafb;
            border: 1px solid rgba(75, 85, 99, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 0.75rem;
        }
        /* æå‡KPIå¡ç‰‡çš„å±‚çº§ä»¥ç¡®ä¿å·¥å…·æç¤ºå¯è§ */
        #kpi-card-1, #kpi-card-2 {
            position: relative;
            z-index: 20;
        }
        /* æ¨¡æ€æ¡†èƒŒæ™¯ */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        /* è¡¨å•è¾“å…¥æ¡†æ ·å¼ */
        .form-input, .form-select, .form-checkbox {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #f3f4f6;
            border-radius: 0.5rem;
        }
        .form-input:focus, .form-select:focus, .form-checkbox:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #1e40af;
        }
        .form-checkbox {
            width: 1.25rem;
            height: 1.25rem;
        }
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* åŠ è½½åŠ¨ç”» */
        .card-animation {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        /* æ‚¬æµ®æŒ‰é’®ç»„æ ·å¼ */
        .fab-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 30; }
        .fab-main, .fab-secondary {
            width: 3.5rem; height: 3.5rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center;
            color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1); transition: all 0.3s ease;
        }
        .fab-main { background-color: #4f46e5; z-index: 20; cursor: pointer; }
        .fab-main:hover { background-color: #4338ca; transform: rotate(90deg) scale(1.1); }
        .fab-secondary { position: absolute; bottom: 0; right: 0; opacity: 0; transform: translateY(0) scale(0.5); pointer-events: none; background-color: #6b7280; }
        .fab-secondary:hover { background-color: #4b5563; transform: scale(1.1); }
        .fab-container.open .fab-secondary { opacity: 1; pointer-events: auto; }
        .fab-container.open .fab-secondary:nth-child(1) { transform: translateY(-4.5rem); transition-delay: 0.1s; }
        .fab-container.open .fab-secondary:nth-child(2) { transform: translateY(-9rem); transition-delay: 0.2s; }
        .fab-container.open .fab-main { transform: rotate(135deg); background-color: #4338ca; }
        
        /* è¡¨å¤´å›ºå®š */
        #list-modal .overflow-auto, #full-chart-modal .overflow-auto { max-height: 70vh; }
        #list-modal thead, #full-chart-modal thead { position: sticky; top: 0; z-index: 10; }

        /* åªè¯»æ¨¡å¼ä¸‹ç¦ç”¨æŒ‰é’®çš„æ ·å¼ */
        .readonly-mode-disabled {
            cursor: not-allowed;
            background-color: #4b5563 !important;
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="h-full flex flex-col p-4">

    <!-- Main App Container -->
    <div id="app-container" class="max-w-screen-2xl mx-auto flex flex-col flex-grow w-full min-h-0">
        <!-- å“åº”å¼ Header -->
        <header class="mb-4 flex flex-col sm:flex-row sm:flex-wrap justify-between items-center gap-4 flex-shrink-0">
            <div class="text-center sm:text-left">
                <h1 class="text-3xl font-bold text-white">ğŸ® æ¸¸æˆæ•°æ®ä»ªè¡¨ç›˜</h1>
                <p id="dashboard-subtitle" class="text-gray-400 mt-1">é‡åŒ–æ‚¨çš„æ¸¸æˆçˆ±å¥½ï¼šæ—¶é—´ä¸èµ„é‡‘æŠ•å…¥åˆ†æ</p>
            </div>
            <div class="flex flex-wrap justify-center items-center gap-4">
                 <input type="file" id="csv-import-input" class="hidden" accept=".csv">
                 
                 <div class="text-center sm:text-right">
                    <p id="last-updated" class="text-sm text-gray-400">æ­£åœ¨åŠ è½½æ•°æ®...</p>
                    <p class="text-xs text-gray-500 mt-1">Powered by Firebase. Co-Developed by Tedi-Dino & Gemini â¤ï¸</p>
                 </div>

                 <div class="flex items-center space-x-2">
                    <div id="auth-controls">
                        <!-- Logged out state -->
                        <button id="login-btn" title="ç®¡ç†å‘˜ç™»å½•" class="w-10 h-10 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full transition-colors">
                            <i class="fab fa-google text-xl"></i>
                        </button>
                        <!-- Logged in state -->
                        <div id="user-info" class="hidden items-center space-x-2">
                           <img id="user-avatar" class="w-10 h-10 rounded-full" alt="User Avatar">
                           <button id="logout-btn" title="ç™»å‡º" class="w-10 h-10 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full transition-colors">
                               <i class="fas fa-sign-out-alt text-xl"></i>
                           </button>
                        </div>
                    </div>
                    <!-- External Links -->
                    <a href="https://steamcommunity.com/profiles/76561199530798696/" target="_blank" title="Steam Profile" class="w-10 h-10 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full transition-colors">
                        <i class="fab fa-steam text-xl"></i>
                    </a>
                    <a href="https://github.com/Tedi-Dino/game-data-dashboard" target="_blank" title="GitHub Repository" class="w-10 h-10 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full transition-colors">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                </div>
                <button id="on-this-day-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">ğŸ’¡ é‚£å¹´ä»Šæ—¥</button>
                <button id="play-next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">ğŸ’¡ æ¥ä¸‹æ¥ç©</button>
                <button id="view-all-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">ğŸ“Š æŸ¥çœ‹æ•°æ®è¯¦æƒ…</button>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒºï¼šä¿®æ”¹äº†paddingä»¥è°ƒæ•´åº•éƒ¨ç•™ç™½ -->
        <main class="dashboard-grid pb-28 lg:pb-2">
            <!-- æ¨¡å—1: æ¶ˆè´¹æ€»è§ˆ (ç§»åŠ¨ç«¯ç¬¬1) -->
            <div id="kpi-card-1" class="dark-card p-4 card-animation lg:col-span-1 lg:row-start-1">
                <h3 class="text-lg font-semibold text-gray-200 mb-2">ğŸ’° æ¶ˆè´¹æ€»è§ˆ</h3>
                <div class="space-y-2 flex-grow">
                    <div>
                        <p class="text-sm text-gray-300">å®é™…æ€»æ”¯å‡º</p>
                        <p id="total-actual-cost" class="text-2xl font-bold text-green-400">Â¥0.00</p>
                    </div>
                    <div class="relative group">
                        <p class="text-sm text-gray-300">æ¸¸æˆæ€»æ¶ˆè´¹</p>
                        <div class="flex items-center">
                            <p id="game-actual-cost" class="text-xl font-semibold text-white">Â¥0.00</p>
                            <span class="text-gray-400 font-bold text-lg px-2 opacity-50 group-hover:opacity-100 transition-opacity">&gt;</span>
                        </div>
                        <div id="game-cost-tooltip" class="absolute bottom-full mb-2 left-0 w-72 bg-gray-800 text-white text-sm rounded-lg shadow-lg p-3 z-40 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                    </div>
                     <div>
                        <p class="text-sm text-gray-300">ç¡¬ä»¶æ€»æŠ•å…¥</p>
                        <p id="hardware-actual-cost" class="text-xl font-semibold text-white">Â¥0.00</p>
                    </div>
                    <div class="relative group">
                        <p class="text-sm text-gray-300">æœªé€šå…³æ¸¸æˆä»·å€¼</p>
                        <div class="flex items-center">
                            <p id="unfinished-games-cost" class="text-xl font-semibold text-orange-400">Â¥0.00</p>
                            <span class="text-gray-400 font-bold text-lg px-2 opacity-50 group-hover:opacity-100 transition-opacity">&gt;</span>
                        </div>
                        <div id="unfinished-cost-tooltip" class="absolute bottom-full mb-2 left-0 w-80 bg-gray-800 text-white text-sm rounded-lg shadow-lg p-3 z-40 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡å—2: æ—¶é—´æ€»è§ˆ (ç§»åŠ¨ç«¯ç¬¬2) -->
            <div id="kpi-card-2" class="dark-card p-4 card-animation flex flex-col lg:col-span-1 lg:row-start-2">
                <h3 class="text-lg font-semibold text-gray-200 mb-4">â³ æ—¶é—´æ€»è§ˆ</h3>
                 <div class="space-y-4 flex-grow">
                    <div class="relative group">
                        <p class="text-sm text-gray-300">æ¸¸æˆæ€»æ•°</p>
                        <div class="flex items-center">
                           <p id="total-games" class="text-2xl font-bold text-blue-400">0 æ¬¾</p>
                           <span class="text-gray-400 font-bold text-lg px-2 opacity-50 group-hover:opacity-100 transition-opacity">&gt;</span>
                        </div>
                        <div id="total-games-tooltip" class="absolute bottom-full mb-2 left-0 w-72 bg-gray-800 text-white text-sm rounded-lg shadow-lg p-3 z-40 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                    </div>
                    <div class="relative group">
                        <p class="text-sm text-gray-300">æ€»è®¡æ¸¸ç©</p>
                        <div class="flex items-center">
                           <p id="total-playtime" class="text-xl font-semibold text-white">0.00 å°æ—¶</p>
                           <span class="text-gray-400 font-bold text-lg px-2 opacity-50 group-hover:opacity-100 transition-opacity">&gt;</span>
                        </div>
                        <div id="playtime-tooltip" class="absolute bottom-full mb-2 left-0 w-72 bg-gray-800 text-white text-sm rounded-lg shadow-lg p-3 z-40 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-300">å¹³å‡æ¸¸æˆæ—¶é•¿</p>
                        <p id="avg-playtime" class="text-xl font-semibold text-white">0.00 å°æ—¶/æ¬¾</p>
                    </div>
                    <div class="relative group">
                        <p class="text-sm text-gray-300">å•ä½æ—¶é—´ä»·æ ¼</p>
                        <div class="flex items-center">
                            <p id="cost-per-hour" class="text-xl font-bold text-yellow-400">Â¥0.00</p>
                            <span class="text-gray-400 font-bold text-lg px-2 opacity-50 group-hover:opacity-100 transition-opacity">&gt;</span>
                        </div>
                        <div id="cph-tooltip" class="absolute bottom-full mb-2 left-0 w-80 bg-gray-800 text-white text-sm rounded-lg shadow-lg p-3 z-40 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                    </div>
                </div>
            </div>
            
            <!-- æ¨¡å—3: ä¸‰ä¸ªç¯å½¢å›¾ (ç§»åŠ¨ç«¯ç¬¬3) -->
            <div id="chart-card-all-doughnuts" class="dark-card p-4 card-animation relative flex flex-col lg:col-span-3 lg:row-start-1 min-h-[750px] lg:min-h-0">
                <h3 class="text-lg font-semibold text-gray-200 mb-1">ğŸ“Š æ¶ˆè´¹ã€æ—¶é—´ä¸çˆ±å¥½ç»Ÿè®¡</h3>
                <!-- æ‰‹æœºç«–å±æ—¶çºµå‘æ’åˆ—ï¼Œå¹³æ¿åŠä»¥ä¸Šæ¨ªå‘æ’åˆ— -->
                <div class="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="relative flex flex-col">
                        <div class="flex-grow relative"><canvas id="cost-distribution-chart"></canvas></div>
                        <h4 class="text-center text-sm font-medium text-gray-300 mt-1">é‡‘é¢åˆ†å¸ƒ</h4>
                    </div>
                    <div class="relative flex flex-col">
                        <div class="flex-grow relative"><canvas id="time-distribution-chart"></canvas></div>
                         <h4 class="text-center text-sm font-medium text-gray-300 mt-1">æ—¶é—´åˆ†å¸ƒ</h4>
                    </div>
                    <div class="relative flex flex-col">
                        <div class="flex-grow relative"><canvas id="game-sort-chart"></canvas></div>
                        <h4 class="text-center text-sm font-medium text-gray-300 mt-1">ç©çš„æœ€å¤šçš„æ¸¸æˆç±»å‹</h4>
                    </div>
                </div>
            </div>

            <!-- æ¨¡å—4: ä»·æ ¼ä¸æ—¶é—´åˆ†å¸ƒ (ç§»åŠ¨ç«¯ç¬¬4) -->
            <div id="chart-card-2" class="dark-card p-4 card-animation flex flex-col lg:col-span-2 lg:row-start-1 min-h-[250px] lg:min-h-0">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold text-gray-200">ğŸ“ˆ ä»·æ ¼ä¸æ—¶é—´åˆ†å¸ƒ</h3>
                    <div class="flex items-center bg-gray-700 rounded-lg p-1 text-sm">
                        <button id="dist-time-btn" class="px-3 py-1 font-medium rounded-md bg-indigo-600 text-white transition-colors">æ¸¸æˆæ—¶é•¿</button>
                        <button id="dist-price-btn" class="px-3 py-1 font-medium rounded-md text-gray-300 hover:bg-gray-600 transition-colors">æ¸¸æˆä»·æ ¼</button>
                    </div>
                </div>
                <div class="flex-grow relative">
                    <canvas id="game-distribution-chart"></canvas>
                </div>
            </div>

            <!-- æ¨¡å—5: æœˆåº¦æ¶ˆè´¹ç»Ÿè®¡ (ç§»åŠ¨ç«¯ç¬¬5) -->
            <div id="chart-card-3" class="dark-card p-4 card-animation lg:col-span-5 lg:row-start-2 relative flex flex-col min-h-[300px] lg:min-h-0">
                <div class="flex justify-between items-center gap-4 mb-2">
                     <h3 class="text-lg font-semibold text-gray-200">ğŸ—“ï¸ æœˆåº¦æ¶ˆè´¹ä¸æ—¶é—´ç»Ÿè®¡</h3>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="exclude-hardware-checkbox" class="form-checkbox">
                            <label for="exclude-hardware-checkbox" class="text-sm font-medium text-gray-300 whitespace-nowrap">ä¸è®¡ç¡¬ä»¶</label>
                        </div>
                        <button id="monthly-chart-fullscreen-btn" class="lg:hidden text-gray-300 hover:text-white" title="å…¨å±æŸ¥çœ‹">
                            <i class="fas fa-expand-alt fa-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="flex-grow relative">
                    <canvas id="monthly-trends-chart"></canvas>
                </div>
            </div>
        </main>
    </div>
    
    <!-- æ‚¬æµ®æ“ä½œæŒ‰é’® -->
    <div class="fab-container hidden">
        <button id="export-btn" class="fab-secondary" title="å¯¼å‡º CSV"><i class="fas fa-upload fa-lg"></i></button>
        <button id="import-btn" class="fab-secondary" title="å¯¼å…¥ CSV"><i class="fas fa-download fa-lg"></i></button>
        <div id="add-item-fab" class="fab-main" title="æ·»åŠ è®°å½•">
            <i class="fas fa-plus fa-lg"></i>
        </div>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘è®°å½• æ¨¡æ€æ¡† (å·²é‡æ„) -->
    <div id="item-modal" class="fixed inset-0 z-50 items-center justify-center p-4 hidden modal-backdrop">
        <div class="dark-card w-full max-w-lg mx-auto rounded-lg shadow-xl p-6 relative">
            <h2 id="modal-title" class="text-xl font-bold text-white mb-6">æ·»åŠ è®°å½•</h2>
            <form id="item-form" class="space-y-4">
                <input type="hidden" id="item-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="item-custom-id" class="block text-sm font-medium text-gray-300">ID (è‡ªå®šä¹‰)</label>
                        <input type="text" id="item-custom-id" class="form-input w-full mt-1" required>
                    </div>
                    <div>
                        <label for="item-name" class="block text-sm font-medium text-gray-300">åç§°</label>
                        <input type="text" id="item-name" class="form-input w-full mt-1" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label for="item-type" class="block text-sm font-medium text-gray-300">åˆ†ç±»</label>
                        <select id="item-type" class="form-select w-full mt-1">
                            <option value="hardware">ç¡¬ä»¶è®¾å¤‡</option>
                            <option value="physical">Switchå®ä½“</option>
                            <option value="digital">Switchæ•°å­—</option>
                            <option value="steam">Steamæ¸¸æˆ</option>
                            <option value="epic">Epicæ¸¸æˆ</option>
                            <option value="ubi">Uplayæ¸¸æˆ</option>
                            <option value="ms">MS Storeæ¸¸æˆ</option>
                            <option value="emulator">æ¨¡æ‹Ÿå™¨æ¸¸æˆ</option>
                        </select>
                    </div>
                    <div>
                        <label for="item-sort" class="block text-sm font-medium text-gray-300">æ¸¸æˆç±»å‹</label>
                        <input type="text" id="item-sort" class="form-input w-full mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="item-from" class="block text-sm font-medium text-gray-300">æ¥æº</label>
                        <select id="item-from" class="form-select w-full mt-1">
                            <option value="purchase">è´­ä¹°</option>
                            <option value="free">å…è´¹</option>
                            <option value="friend">èµ é€</option>
                        </select>
                    </div>
                    <div>
                        <label for="purchase-date" class="block text-sm font-medium text-gray-300">è´­å…¥æ—¥æœŸ</label>
                        <input type="date" id="purchase-date" class="form-input w-full mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="purchase-price" class="block text-sm font-medium text-gray-300">è´­å…¥ä»·æ ¼ (Â¥)</label>
                        <input type="number" id="purchase-price" step="0.01" class="form-input w-full mt-1">
                    </div>
                    <div>
                         <label for="play-time" class="block text-sm font-medium text-gray-300">æ¸¸ç©æ—¶é•¿ (å°æ—¶)</label>
                         <input type="number" id="play-time" step="0.01" class="form-input w-full mt-1">
                    </div>
                </div>

                <div id="game-fields" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="item-status" class="block text-sm font-medium text-gray-300">çŠ¶æ€</label>
                            <select id="item-status" class="form-select w-full mt-1">
                                <option value="playing">æ­£åœ¨ç©</option>
                                <option value="backlog">å¾…ç©</option>
                                <option value="passed">å·²é€šå…³</option>
                                <option value="abandoned">å·²å¼ƒå‘</option>
                                <option value="empty">ç©º</option>
                            </select>
                        </div>
                         <div id="pass-date-container" class="hidden">
                             <label for="pass-date" class="block text-sm font-medium text-gray-300">é€šå…³æ—¥æœŸ</label>
                             <input type="date" id="pass-date" class="form-input w-full mt-1">
                         </div>
                    </div>
                    <div>
                        <label for="item-rating" class="block text-sm font-medium text-gray-300">æˆ‘çš„è¯„åˆ† (1-5)</label>
                        <input type="number" id="item-rating" min="1" max="5" step="1" class="form-input w-full mt-1" placeholder="è¾“å…¥1åˆ°5çš„æ•´æ•°">
                    </div>
                </div>
                <div id="resell-fields" class="hidden grid grid-cols-2 gap-4">
                    <div><label for="sell-date" class="block text-sm font-medium text-gray-300">å”®å‡ºæ—¥æœŸ</label><input type="date" id="sell-date" class="form-input w-full mt-1"></div>
                    <div><label for="sell-price" class="block text-sm font-medium text-gray-300">å”®å‡ºä»·æ ¼ (Â¥)</label><input type="number" id="sell-price" step="0.01" class="form-input w-full mt-1"></div>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">åˆ é™¤</button>
                    <button type="button" id="cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit" id="save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ä¿å­˜</button>
                </div>
            </form>
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-300 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </div>
    </div>

    <!-- æ•°æ®è¯¦æƒ… æ¨¡æ€æ¡† (å·²é‡æ„) -->
    <div id="list-modal" class="fixed inset-0 z-50 p-4 hidden modal-backdrop overflow-y-auto">
        <div class="dark-card w-full max-w-7xl mx-auto rounded-lg shadow-xl p-6 relative my-auto flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 id="list-modal-title" class="text-xl font-bold text-white">æ•°æ®è¯¦æƒ…</h2>
                <button id="close-list-modal-btn" class="text-gray-300 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <!-- Search Box -->
            <div class="mb-4">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="list-search-input" class="form-input w-full pl-10" placeholder="æœç´¢åç§°ã€åˆ†ç±»ã€ç±»å‹...">
                </div>
            </div>
            <div class="overflow-auto">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="id">ID</th>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="name">åç§°</th>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="sort">åˆ†ç±»</th>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="type">ç±»å‹</th>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="from">æ¥æº</th>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="status">çŠ¶æ€</th>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="purchaseDate">è´­å…¥æ—¥æœŸ</th>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="purchasePrice">è´­å…¥ä»·æ ¼</th>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="actualCost">å®é™…æ”¯å‡º</th>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="playTime">æ¸¸ç©æ—¶é•¿</th>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="costPerHour">æ—¶é—´æˆæœ¬</th>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="rating">è¯„åˆ†</th>
                            <th scope="col" class="px-4 py-3 sortable-header cursor-pointer" data-sort="passDate">é€šå…³æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody id="items-table-body"></tbody>
                </table>
                 <div id="no-data-list-message" class="text-center py-10 text-gray-500 hidden">æš‚æ— æ•°æ®</div>
            </div>
        </div>
    </div>

    <!-- æœˆåº¦æ¶ˆè´¹ç»Ÿè®¡-å…¨å± æ¨¡æ€æ¡† (ä¿®æ”¹) -->
    <div id="monthly-chart-fullscreen-modal" class="fixed inset-0 z-[55] items-center justify-center p-2 sm:p-4 hidden modal-backdrop">
        <div class="dark-card w-full h-full mx-auto rounded-lg shadow-xl p-4 sm:p-6 relative flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-xl font-bold text-white">æœˆåº¦æ¶ˆè´¹ä¸æ—¶é—´ç»Ÿè®¡</h2>
                <button id="close-monthly-chart-fullscreen-btn" class="text-gray-300 hover:text-white" title="é€€å‡ºå…¨å±">
                    <i class="fas fa-compress-alt fa-lg"></i>
                </button>
            </div>
            <!-- ä¿®æ”¹ä¸ºæ°´å¹³æ»šåŠ¨ -->
            <div class="flex-grow relative overflow-x-auto">
                <!-- å®¹å™¨çš„é«˜åº¦ä¸º100%ï¼Œå®½åº¦å°†ç”±JSåŠ¨æ€è®¾ç½® -->
                <div class="h-full"> 
                     <canvas id="monthly-trends-chart-fullscreen"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é‚£å¹´ä»Šæ—¥ æ¨¡æ€æ¡† -->
    <div id="on-this-day-modal" class="fixed inset-0 z-50 items-center justify-center p-4 hidden modal-backdrop">
        <div class="dark-card w-full max-w-md mx-auto rounded-lg shadow-xl p-6 relative">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">ğŸ’¡ é‚£å¹´ä»Šæ—¥</h2>
                <button id="close-on-this-day-modal-btn" class="text-gray-300 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div id="on-this-day-content" class="space-y-4 max-h-[60vh] overflow-y-auto text-gray-300">
                <!-- Content will be generated by JS -->
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤æ“ä½œ æ¨¡æ€æ¡† -->
    <div id="confirm-modal" class="fixed inset-0 z-[60] items-center justify-center p-4 hidden modal-backdrop">
        <div class="dark-card w-full max-w-sm mx-auto rounded-lg shadow-xl p-6 relative">
            <h2 id="confirm-modal-title" class="text-lg font-bold text-white mb-4">è¯·ç¡®è®¤</h2>
            <p id="confirm-modal-message" class="text-gray-300 mb-6">æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="confirm-cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                <button type="button" id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <!-- æ¥ä¸‹æ¥ç© æ¨¡æ€æ¡† -->
    <div id="play-next-modal" class="fixed inset-0 z-50 items-center justify-center p-4 hidden modal-backdrop">
        <div class="dark-card w-full max-w-4xl mx-auto rounded-lg shadow-xl p-6 relative flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-xl font-bold text-white">ğŸ’¡ æ¥ä¸‹æ¥ç©ä»€ä¹ˆï¼Ÿ</h2>
                <button id="close-play-next-modal-btn" class="text-gray-300 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <!-- å“åº”å¼åŒåˆ—å¸ƒå±€ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow min-h-0">
                <!-- å·¦åˆ—: æˆ‘çš„å¾…ç©åˆ—è¡¨ -->
                <div class="flex flex-col min-h-0">
                    <h3 class="text-lg font-semibold text-indigo-400 mb-2 flex-shrink-0">ğŸ“Œ æˆ‘çš„å¾…ç©åˆ—è¡¨ (Backlog)</h3>
                    <div id="my-play-next-list" class="space-y-2 overflow-y-auto pr-2">
                        <!-- User's backlog games will be inserted here -->
                    </div>
                </div>
                <!-- å³åˆ—: AI æ¨è -->
                <div class="flex flex-col min-h-0">
                    <h3 class="text-lg font-semibold text-teal-400 mb-2 flex-shrink-0">ğŸ¤– AI æ¨è</h3>
                    <!-- AI Prompt Input -->
                    <div class="flex gap-2 mb-3 flex-shrink-0">
                        <input type="text" id="ai-prompt-input" class="form-input flex-grow" placeholder="è¾“å…¥ä½ æƒ³ç©çš„æ¸¸æˆç±»å‹æˆ–é£æ ¼...">
                        <button id="ai-prompt-send-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-3 rounded-lg transition-colors">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="ai-recommendations-list" class="space-y-3 overflow-y-auto pr-2">
                        <!-- AI recommendations will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>


<script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, writeBatch, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

    // --- ã€é‡è¦ã€‘è¯·åœ¨æ­¤å¤„é…ç½®æ‚¨çš„ç®¡ç†å‘˜UIDåˆ—è¡¨ ---
    const ADMIN_UIDS = ['ZPyHfPGUI4elNvRN2Q30ZqfzT6X2'];

    // --- Firebase Initialization ---
    let app, auth, db, functions;
    let userId = null;
    let itemsCollectionRef;
    let unsubscribe = null; 

    try {
        const firebaseConfig = {
         apiKey: "AIzaSyAE7weH2hOhhswg8x51Uz0TMxn-jO_Ap0k",
         authDomain: "game-data-dashboard.firebaseapp.com",
         projectId: "game-data-dashboard",
         storageBucket: "game-data-dashboard.firebasestorage.app",
         messagingSenderId: "84289557335",
         appId: "1:84289557335:web:f31479532875af0558a412",
         measurementId: "G-P9L1V42JK6"
        };
    
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        functions = getFunctions(app);

    } catch (e) {
        console.error("Error initializing Firebase:", e);
        document.body.innerHTML = '<div class="text-white text-center p-8">Firebase initialization failed. Please check the configuration.</div>';
    }


    document.addEventListener('DOMContentLoaded', () => {

        // --- DOM Elements ---
        const elements = {
            appContainer: document.getElementById('app-container'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            userInfo: document.getElementById('user-info'),
            userAvatar: document.getElementById('user-avatar'),
            authControls: document.getElementById('auth-controls'),
            lastUpdated: document.getElementById('last-updated'),
            totalActualCost: document.getElementById('total-actual-cost'), gameActualCost: document.getElementById('game-actual-cost'), hardwareActualCost: document.getElementById('hardware-actual-cost'), unfinishedGamesCost: document.getElementById('unfinished-games-cost'), totalPlaytime: document.getElementById('total-playtime'), avgPlaytime: document.getElementById('avg-playtime'), costPerHour: document.getElementById('cost-per-hour'), totalGames: document.getElementById('total-games'), gameCostTooltip: document.getElementById('game-cost-tooltip'), playtimeTooltip: document.getElementById('playtime-tooltip'), cphTooltip: document.getElementById('cph-tooltip'), addItemFab: document.getElementById('add-item-fab'), itemModal: document.getElementById('item-modal'), modalTitle: document.getElementById('modal-title'), itemForm: document.getElementById('item-form'), itemId: document.getElementById('item-id'), itemCustomId: document.getElementById('item-custom-id'), itemName: document.getElementById('item-name'), itemType: document.getElementById('item-type'), itemFrom: document.getElementById('item-from'), purchaseDate: document.getElementById('purchase-date'), purchasePrice: document.getElementById('purchase-price'), playTime: document.getElementById('play-time'), passDateContainer: document.getElementById('pass-date-container'), passDate: document.getElementById('pass-date'), sellDate: document.getElementById('sell-date'), sellPrice: document.getElementById('sell-price'), deleteBtn: document.getElementById('delete-btn'), cancelBtn: document.getElementById('cancel-btn'), closeModalBtn: document.getElementById('close-modal-btn'), gameFields: document.getElementById('game-fields'), resellFields: document.getElementById('resell-fields'), importBtn: document.getElementById('import-btn'), exportBtn: document.getElementById('export-btn'), csvImportInput: document.getElementById('csv-import-input'), viewAllBtn: document.getElementById('view-all-btn'), listModal: document.getElementById('list-modal'), listModalTitle: document.getElementById('list-modal-title'), closeListModalBtn: document.getElementById('close-list-modal-btn'), itemsTableBody: document.getElementById('items-table-body'), noDataListMessage: document.getElementById('no-data-list-message'), fabContainer: document.querySelector('.fab-container'),
            unfinishedCostTooltip: document.getElementById('unfinished-cost-tooltip'),
            excludeHardwareCheckbox: document.getElementById('exclude-hardware-checkbox'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmModalMessage: document.getElementById('confirm-modal-message'),
            confirmOkBtn: document.getElementById('confirm-ok-btn'),
            confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
            totalGamesTooltip: document.getElementById('total-games-tooltip'),
            itemSort: document.getElementById('item-sort'),
            saveBtn: document.getElementById('save-btn'),
            dashboardSubtitle: document.getElementById('dashboard-subtitle'),
            distTimeBtn: document.getElementById('dist-time-btn'),
            distPriceBtn: document.getElementById('dist-price-btn'),
            monthlyChartFullscreenBtn: document.getElementById('monthly-chart-fullscreen-btn'),
            monthlyChartFullscreenModal: document.getElementById('monthly-chart-fullscreen-modal'),
            closeMonthlyChartFullscreenBtn: document.getElementById('close-monthly-chart-fullscreen-btn'),
            onThisDayBtn: document.getElementById('on-this-day-btn'),
            onThisDayModal: document.getElementById('on-this-day-modal'),
            closeOnThisDayModalBtn: document.getElementById('close-on-this-day-modal-btn'),
            onThisDayContent: document.getElementById('on-this-day-content'),
            playNextBtn: document.getElementById('play-next-btn'),
            playNextModal: document.getElementById('play-next-modal'),
            closePlayNextModalBtn: document.getElementById('close-play-next-modal-btn'),
            myPlayNextList: document.getElementById('my-play-next-list'),
            aiRecommendationsList: document.getElementById('ai-recommendations-list'),
            itemStatus: document.getElementById('item-status'),
            itemRating: document.getElementById('item-rating'),
            listSearchInput: document.getElementById('list-search-input'),
            aiPromptInput: document.getElementById('ai-prompt-input'),
            aiPromptSendBtn: document.getElementById('ai-prompt-send-btn'),
        };
    
        // --- App State ---
        let items = [];
        let charts = {};
        let sortConfig = { key: 'id', direction: 'desc' };
        let isEditingFromList = false;
        let gameDistributionMode = 'time'; // 'time' or 'price'
        const PLATFORM_COLORS = { hardware: '#6b7280', switch_physical: '#E60012', switch_digital: '#ff4e5c', steam: '#3b82f6', epic: '#f2f2f2', ubi: '#a855f7', ms: '#107C10', emulator: '#fde047', other: '#f97316' };
    
        // --- Utility Functions ---
        const formatCurrency = (value) => `Â¥${(value || 0).toFixed(2)}`;
        const parseFloatOrNull = (value) => (value === '' || value === null || isNaN(parseFloat(value)) ? null : parseFloat(value));
        const parseDateOrNull = (value) => (value ? value : null);
        
        // (é‡æ„) è¯„åˆ†æ˜Ÿæ˜Ÿæ¸²æŸ“å‡½æ•°
        const renderStars = (rating) => {
            if (!rating || rating < 1) return '';
            const solidStar = 'â˜…';
            return `<span class="text-yellow-400 ml-2">${solidStar.repeat(rating)}</span>`;
        };
        const renderStarsForTable = (rating) => {
            if (!rating || rating < 1) return '/';
            return renderStars(rating).replace('ml-2', ''); // No margin for table
        }
        
        // --- Authentication Functions ---
        const signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
            }
        };

        const signOutUser = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign-Out Error:", error);
            }
        };

        // --- Firestore Data Listener ---
        const setupFirestoreListener = () => {
            if (unsubscribe) unsubscribe();
            itemsCollectionRef = collection(db, "items");
            unsubscribe = onSnapshot(itemsCollectionRef, (snapshot) => {
                items = snapshot.docs.map(doc => ({ fb_id: doc.id, ...doc.data() }));
                updateDashboard();
                if (!elements.listModal.classList.contains('hidden')) {
                    renderItemsList();
                }
            }, (error) => {
                console.error("Error fetching data from Firestore: ", error);
                elements.lastUpdated.textContent = 'æ•°æ®åŠ è½½å¤±è´¥';
                elements.dashboardSubtitle.textContent = 'åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥Firebaseå®‰å…¨è§„åˆ™ã€‚';
                elements.dashboardSubtitle.classList.add('text-red-500');
            });
        };

        const updateLastModifiedTimestamp = async () => {
            try {
                const metadataRef = doc(db, 'metadata', 'dashboard');
                await setDoc(metadataRef, { lastManualUpdate: new Date() });
            } catch (error) {
                console.error("Error updating last modified timestamp:", error);
            }
        };

        const setupMetadataListener = () => {
            const metadataRef = doc(db, 'metadata', 'dashboard');
            onSnapshot(metadataRef, (doc) => {
                if (doc.exists() && doc.data().lastManualUpdate) {
                    const lastUpdateDate = doc.data().lastManualUpdate.toDate();
                    const formattedDate = `${('0' + (lastUpdateDate.getMonth() + 1)).slice(-2)}/${('0' + lastUpdateDate.getDate()).slice(-2)} ${('0' + lastUpdateDate.getHours()).slice(-2)}:${('0' + lastUpdateDate.getMinutes()).slice(-2)}`;
                    elements.lastUpdated.textContent = `æ•°æ®æ›´æ–°äº ${formattedDate}`;
                } else {
                    elements.lastUpdated.textContent = 'æš‚æ— æ›´æ–°è®°å½•';
                }
            }, (error) => {
                console.error("Error fetching metadata:", error);
                elements.lastUpdated.textContent = 'æ›´æ–°æ—¶é—´åŠ è½½å¤±è´¥';
            });
        };
        
        // --- UI Access Control ---
        const updateUIAccess = (currentUserId) => {
            const isReadOnly = !currentUserId || !ADMIN_UIDS.includes(currentUserId);
            const writeButtons = [ elements.addItemFab, elements.importBtn, elements.deleteBtn, elements.saveBtn ];
    
            if (isReadOnly) {
                elements.fabContainer.classList.add('hidden');
                writeButtons.forEach(btn => {
                    btn.classList.add('readonly-mode-disabled');
                    btn.title = 'éœ€è¦ç®¡ç†å‘˜æƒé™';
                });
                elements.itemsTableBody.style.pointerEvents = 'none';
            } else {
                elements.fabContainer.classList.remove('hidden');
                 writeButtons.forEach(btn => {
                    btn.classList.remove('readonly-mode-disabled');
                    btn.title = '';
                });
                elements.itemsTableBody.style.pointerEvents = 'auto';
            }
        };
        
        // --- Modal Management ---
        const openModal = (modal) => modal.classList.remove('hidden') || modal.classList.add('flex');
        const closeModal = (modal) => modal.classList.add('hidden') || modal.classList.remove('flex');
    
        const showConfirmation = (message, onConfirm) => {
            elements.confirmModalMessage.textContent = message;
            const newConfirmBtn = elements.confirmOkBtn.cloneNode(true);
            elements.confirmOkBtn.parentNode.replaceChild(newConfirmBtn, elements.confirmOkBtn);
            elements.confirmOkBtn = newConfirmBtn;
            elements.confirmOkBtn.addEventListener('click', () => {
                closeModal(elements.confirmModal);
                onConfirm();
            }, { once: true });
            openModal(elements.confirmModal);
        };
    
        const closeItemModalAndReturnToList = () => {
            closeModal(elements.itemModal);
            if (isEditingFromList) {
                renderItemsList();
                updateSortHeaders();
                openModal(elements.listModal);
            }
            isEditingFromList = false;
        };
    
        // --- Chart Rendering ---
        const renderCharts = () => { Object.values(charts).forEach(chart => { if(chart && chart.destroy) chart.destroy() }); charts = {}; renderCostDistributionChart(); renderTimeDistributionChart(); renderGameDistributionChart(); renderMonthlyTrendsChart(); renderGameSortChart(); };
        const setupChartDefaults = () => { Chart.defaults.color = '#f9fafb'; Chart.defaults.borderColor = 'rgba(107, 114, 128, 0.5)'; Chart.defaults.plugins.legend.position = 'bottom'; Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(31, 41, 55, 0.9)'; Chart.defaults.plugins.tooltip.borderColor = '#4b5563'; Chart.defaults.plugins.tooltip.borderWidth = 1; Chart.defaults.plugins.tooltip.padding = 10; Chart.defaults.plugins.tooltip.titleFont = { weight: 'bold' }; }
        const createExternalTooltip = (formatter) => { let tooltipEl = document.getElementById('chartjs-external-tooltip'); if (!tooltipEl) { tooltipEl = document.createElement('div'); tooltipEl.id = 'chartjs-external-tooltip'; tooltipEl.className = 'absolute bg-gray-800 text-white text-sm rounded-lg shadow-lg p-3 z-[999] pointer-events-none opacity-0 transition-opacity w-80'; document.body.appendChild(tooltipEl); } return (context) => { const { chart, tooltip } = context; if (tooltip.opacity === 0) { tooltipEl.style.opacity = 0; return; } const html = formatter(tooltip); if (!html) { tooltipEl.style.opacity = 0; return; } tooltipEl.innerHTML = html; const chartRect = chart.canvas.getBoundingClientRect(); tooltipEl.style.opacity = 1; tooltipEl.style.left = `${chartRect.left + window.scrollX + tooltip.caretX}px`; tooltipEl.style.top = `${chartRect.top + window.scrollY + tooltip.caretY}px`; let transform = 'translate(-50%, -110%)'; const tooltipRect = tooltipEl.getBoundingClientRect(); if (tooltipRect.top < 0) { transform = 'translate(-50%, 20px)'; } if (tooltipRect.right > window.innerWidth) { transform = 'translate(-100%, -110%)'; } if (tooltipRect.left < 0) { transform = 'translate(0, -110%)'; } tooltipEl.style.transform = transform; }; };
        const renderCostDistributionChart = () => { const costReducer = (s, i) => s + (i.purchasePrice || 0) - (i.sellPrice || 0); const data = { 'ç¡¬ä»¶è®¾å¤‡': items.filter(i => i.type === 'hardware').reduce(costReducer, 0), 'Switch å®ä½“': items.filter(i => i.type === 'physical').reduce(costReducer, 0), 'Switch æ•°å­—': items.filter(i => i.type === 'digital').reduce(costReducer, 0), 'Steam æ¸¸æˆ': items.filter(i => i.type === 'steam').reduce(costReducer, 0), 'Epic æ¸¸æˆ': items.filter(i => i.type === 'epic').reduce(costReducer, 0), 'Uplay æ¸¸æˆ': items.filter(i => i.type === 'ubi').reduce(costReducer, 0), 'MS Store æ¸¸æˆ': items.filter(i => i.type === 'ms').reduce(costReducer, 0), 'æ¨¡æ‹Ÿå™¨æ¸¸æˆ': items.filter(i => i.type === 'emulator').reduce(costReducer, 0) }; const filteredData = Object.fromEntries(Object.entries(data).filter(([_, v]) => v > 0)); const el = document.getElementById('cost-distribution-chart'); if (!el) return; charts.costDistribution = new Chart(el, { type: 'doughnut', data: { labels: Object.keys(filteredData), datasets: [{ data: Object.values(filteredData), backgroundColor: Object.keys(filteredData).map(label => { const typeMap = {'ç¡¬ä»¶è®¾å¤‡': 'hardware', 'Switch å®ä½“': 'switch_physical', 'Switch æ•°å­—': 'switch_digital', 'Steam æ¸¸æˆ': 'steam', 'Epic æ¸¸æˆ': 'epic', 'Uplay æ¸¸æˆ': 'ubi', 'MS Store æ¸¸æˆ': 'ms', 'æ¨¡æ‹Ÿå™¨æ¸¸æˆ': 'emulator'}; return PLATFORM_COLORS[typeMap[label]]; }), hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false }, tooltip: { enabled: false, external: createExternalTooltip((tooltip) => { if (!tooltip.body) return null; const label = tooltip.title?.[0]; if (!label) return null; const value = tooltip.dataPoints[0].parsed; const total = tooltip.dataPoints[0].dataset.data.reduce((a, b) => a + b, 0); if (total === 0) return null; const percentage = ((value / total) * 100).toFixed(1); const typeMap = { 'ç¡¬ä»¶è®¾å¤‡': ['hardware'], 'Switch å®ä½“': ['physical'], 'Switch æ•°å­—': ['digital'], 'Steam æ¸¸æˆ': ['steam'], 'Epic æ¸¸æˆ': ['epic'], 'Uplay æ¸¸æˆ': ['ubi'], 'MS Store æ¸¸æˆ': ['ms'], 'æ¨¡æ‹Ÿå™¨æ¸¸æˆ': ['emulator'] }; const topItems = items.filter(i => typeMap[label]?.includes(i.type)).map(i => ({ name: i.name, value: (i.purchasePrice || 0) - (i.sellPrice || 0) })).sort((a, b) => b.value - a.value).slice(0, 5); let innerHtml = `<div class="font-bold text-base mb-2 border-b border-gray-600 pb-1 flex justify-between"><span>${label}</span><span>${formatCurrency(value)} (${percentage}%)</span></div><h4 class="font-semibold mt-2 mb-1">æ”¯å‡º Top 5</h4><ul class="text-sm">`; topItems.forEach(item => { innerHtml += `<li class="flex justify-between my-1"><span>${item.name.substring(0, 20)}</span><strong>${formatCurrency(item.value)}</strong></li>`; }); if (topItems.length === 0 || topItems.every(i => i.value === 0)) innerHtml += '<li>æ— æ”¯å‡ºè®°å½•</li>'; innerHtml += '</ul>'; return innerHtml; }) } } } }); };
        const renderTimeDistributionChart = () => { const timeReducer = (s, i) => s + (i.playTime || 0); const data = { 'Switch': items.filter(i => ['physical', 'digital'].includes(i.type)).reduce(timeReducer, 0), 'Steam': items.filter(i => i.type === 'steam').reduce(timeReducer, 0), 'Epic': items.filter(i => i.type === 'epic').reduce(timeReducer, 0), 'Uplay': items.filter(i => i.type === 'ubi').reduce(timeReducer, 0), 'MS Store': items.filter(i => i.type === 'ms').reduce(timeReducer, 0), 'æ¨¡æ‹Ÿå™¨': items.filter(i => i.type === 'emulator').reduce(timeReducer, 0) }; const filteredData = Object.fromEntries(Object.entries(data).filter(([_, v]) => v > 0)); const el = document.getElementById('time-distribution-chart'); if (!el) return; charts.timeDistribution = new Chart(el, { type: 'doughnut', data: { labels: Object.keys(filteredData), datasets: [{ data: Object.values(filteredData), backgroundColor: Object.keys(filteredData).map(label => { const typeMap = {'Switch': 'switch_physical', 'Steam': 'steam', 'Epic': 'epic', 'Uplay': 'ubi', 'MS Store': 'ms', 'æ¨¡æ‹Ÿå™¨': 'emulator'}; return PLATFORM_COLORS[typeMap[label]]; }), hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false }, tooltip: { enabled: false, external: createExternalTooltip((tooltip) => { if (!tooltip.body) return null; const label = tooltip.title?.[0]; if (!label) return null; const value = tooltip.dataPoints[0].parsed; const total = tooltip.dataPoints[0].dataset.data.reduce((a, b) => a + b, 0); if (total === 0) return null; const percentage = ((value / total) * 100).toFixed(1); const typeMap = { 'Switch': ['physical', 'digital'], 'Steam': ['steam'], 'Epic': ['epic'], 'Uplay': ['ubi'], 'MS Store': ['ms'], 'æ¨¡æ‹Ÿå™¨': ['emulator'] }; const topItems = items.filter(i => typeMap[label]?.includes(i.type)).sort((a, b) => (b.playTime || 0) - (a.playTime || 0)).slice(0, 5); let innerHtml = `<div class="font-bold text-base mb-2 border-b border-gray-600 pb-1 flex justify-between"><span>${label}</span><span>${value.toFixed(1)}h (${percentage}%)</span></div><h4 class="font-semibold mt-2 mb-1">æ—¶é•¿ Top 5</h4><ul class="text-sm">`; topItems.forEach(item => { innerHtml += `<li class="flex justify-between my-1"><span>${(item.name).substring(0, 20)}</span><strong>${(item.playTime || 0).toFixed(1)}h</strong></li>`; }); if (topItems.length === 0 || topItems.every(i => !(i.playTime > 0))) innerHtml += '<li>æ— æ¸¸ç©è®°å½•</li>'; innerHtml += '</ul>'; return innerHtml; }) } } } }); };
        const renderGameSortChart = () => { const gamesWithSort = items.filter(i => i.type !== 'hardware' && i.sort && i.playTime > 0); const timeBySort = gamesWithSort.reduce((acc, game) => { acc[game.sort] = (acc[game.sort] || 0) + (game.playTime || 0); return acc; }, {}); const sortedData = Object.entries(timeBySort).sort((a, b) => b[1] - a[1]); const labels = sortedData.map(d => d[0]); const data = sortedData.map(d => d[1]); const hashCode = s => s.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0); const backgroundColors = labels.map(label => `hsl(${hashCode(label) % 360}, 70%, 60%)`); const el = document.getElementById('game-sort-chart'); if (!el) return; charts.gameSort = new Chart(el, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: backgroundColors, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false }, tooltip: { enabled: false, external: createExternalTooltip((tooltip) => { if (!tooltip.body) return null; const label = tooltip.title?.[0]; if (!label) return null; const value = tooltip.dataPoints[0].parsed; const total = tooltip.dataPoints[0].dataset.data.reduce((a, b) => a + b, 0); if (total === 0) return null; const percentage = ((value / total) * 100).toFixed(1); const topGames = items.filter(i => i.sort === label && i.playTime > 0).sort((a, b) => (b.playTime || 0) - (a.playTime || 0)).slice(0, 3); let innerHtml = `<div class="font-bold text-base mb-2 border-b border-gray-600 pb-1 flex justify-between"><span>${label}</span><span>${value.toFixed(1)}h (${percentage}%)</span></div><h4 class="font-semibold mt-2 mb-1">è¯¥ç±»å‹æ—¶é•¿ Top 3</h4><ul class="text-sm">`; topGames.forEach(item => { innerHtml += `<li class="flex justify-between my-1"><span>${(item.name).substring(0, 15)}</span><span class="flex items-center"><strong>${(item.playTime || 0).toFixed(1)}h</strong>${renderStars(item.rating)}</span></li>`; }); if (topGames.length === 0) innerHtml += '<li>æ— æ¸¸ç©è®°å½•</li>'; innerHtml += '</ul>'; return innerHtml; }) } } } }); };
        
        const renderGameDistributionChart = () => {
            const games = items.filter(i => i.type !== 'hardware');
            let labels = [];
            let data = [];
            let chartLabel = 'æ¸¸æˆæ•°é‡';
            const timeRanges = [[0, 1], [1, 5], [5, 10], [10, 30], [30, 50], [50, 80], [80, Infinity]];
            const priceRanges = [[0, 10], [10, 30], [30, 50], [50, 80], [80, 100], [100, Infinity]];

            if (gameDistributionMode === 'time') {
                labels = ['0-1h', '1-5h', '5-10h', '10-30h', '30-50h', '50-80h', '80h+'];
                const bins = Array(labels.length).fill(0);
                games.forEach(game => {
                    const time = game.playTime || 0;
                    for (let i = 0; i < timeRanges.length; i++) {
                        const [min, max] = timeRanges[i];
                        if (i === 0 ? (time >= min && time <= max) : (time > min && time <= max)) {
                            bins[i]++;
                            break;
                        }
                    }
                });
                data = bins;
            } else { // price mode
                labels = ['0-10', '10-30', '30-50', '50-80', '80-100', '100+'];
                const bins = Array(labels.length).fill(0);
                games.forEach(game => {
                    const cost = (game.purchasePrice || 0) - (game.sellPrice || 0);
                    for (let i = 0; i < priceRanges.length; i++) {
                        const [min, max] = priceRanges[i];
                        if (i === 0 ? (cost >= min && cost <= max) : (cost > min && cost <= max)) {
                            bins[i]++;
                            break;
                        }
                    }
                });
                data = bins;
            }

            const el = document.getElementById('game-distribution-chart');
            if (!el) return;
            if (charts.gameDistribution) charts.gameDistribution.destroy();

            charts.gameDistribution = new Chart(el, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartLabel,
                        data: data,
                        backgroundColor: '#f97316',
                        borderColor: '#fb923c',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(107, 114, 128, 0.5)' }, ticks: { precision: 0 } },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                             enabled: false,
                             external: createExternalTooltip((tooltip) => {
                                if (!tooltip.body || !tooltip.dataPoints.length) return null;
                                const dataPoint = tooltip.dataPoints[0];
                                const label = dataPoint.label;
                                const count = dataPoint.raw;
                                const index = dataPoint.dataIndex;
                                if (count === 0) return null;
                                
                                let gameList = [];
                                if (gameDistributionMode === 'time') {
                                    const [min, max] = timeRanges[index];
                                    gameList = games.filter(g => {
                                        const time = g.playTime || 0;
                                        return index === 0 ? (time >= min && time <= max) : (time > min && time <= max);
                                    }).map(g => g.name);
                                } else {
                                    const [min, max] = priceRanges[index];
                                    gameList = games.filter(g => {
                                        const cost = (g.purchasePrice || 0) - (g.sellPrice || 0);
                                        return index === 0 ? (cost >= min && cost <= max) : (cost > min && cost <= max);
                                    }).map(g => g.name);
                                }
                                
                                let listHtml = gameList.slice(0, 10).map(name => `<li class="truncate">${name}</li>`).join('');
                                if (gameList.length > 10) listHtml += `<li class="text-gray-400">...ç­‰å¦å¤– ${gameList.length - 10} æ¬¾</li>`;

                                return `<div class="font-bold text-base mb-2 border-b border-gray-600 pb-1 flex justify-between">
                                            <span>${label}</span><span>${count} æ¬¾</span>
                                        </div>
                                        <ul class="text-sm space-y-1">${listHtml || '<li>æš‚æ— æ¸¸æˆ</li>'}</ul>`;
                             })
                        }
                    },
                }
            });
        };

        const renderMonthlyTrendsChart = (isFullscreen = false) => {
            const canvasId = isFullscreen ? 'monthly-trends-chart-fullscreen' : 'monthly-trends-chart';
            const chartKey = isFullscreen ? 'monthlyTrendsFullscreen' : 'monthlyTrends';
            
            const excludeHardware = elements.excludeHardwareCheckbox.checked; 
            const currentItems = excludeHardware ? items.filter(i => i.type !== 'hardware') : items; 
            const trends = {}; const allMonths = new Set(); 
            const normalizeMonth = (dateStr) => { if (!dateStr) return null; const date = new Date(dateStr); if (isNaN(date.getTime())) return null; return date.getFullYear() + '-' + ('0' + (date.getMonth() + 1)).slice(-2); }; 
            currentItems.forEach(item => { if (item.purchaseDate) { const purchaseMonth = normalizeMonth(item.purchaseDate); if(purchaseMonth) { allMonths.add(purchaseMonth); if (!trends[purchaseMonth]) trends[purchaseMonth] = { hardware: 0, switch_physical: 0, switch_digital: 0, steam: 0, epic: 0, ubi: 0, ms: 0, emulator: 0, playtime: 0 }; const cost = (item.purchasePrice || 0) - (item.sellPrice || 0); if (item.type === 'hardware') trends[purchaseMonth].hardware += cost; else if (item.type === 'physical') trends[purchaseMonth].switch_physical += cost; else if (item.type === 'digital') trends[purchaseMonth].switch_digital += cost; else if (item.type === 'steam') trends[purchaseMonth].steam += cost; else if (item.type === 'epic') trends[purchaseMonth].epic += cost; else if (item.type === 'ubi') trends[purchaseMonth].ubi += cost; else if (item.type === 'ms') trends[purchaseMonth].ms += cost; else if (item.type === 'emulator') trends[purchaseMonth].emulator += cost; } } if (item.type !== 'hardware' && item.playTime > 0 && item.purchaseDate) { if (item.status === 'passed' && item.passDate) { const startDate = new Date(item.purchaseDate); const endDate = new Date(item.passDate); if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime()) && startDate <= endDate) { const totalDurationDays = Math.max(1, (endDate - startDate) / (1000 * 60 * 60 * 24) + 1); const dailyPlaytime = item.playTime / totalDurationDays; for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) { const monthStr = normalizeMonth(d); if(monthStr){ allMonths.add(monthStr); if (!trends[monthStr]) trends[monthStr] = { hardware: 0, switch_physical: 0, switch_digital: 0, steam: 0, epic: 0, ubi: 0, ms: 0, emulator: 0, playtime: 0 }; trends[monthStr].playtime += dailyPlaytime; } } return; } } const purchaseMonth = normalizeMonth(item.purchaseDate); if(purchaseMonth) { allMonths.add(purchaseMonth); if (!trends[purchaseMonth]) trends[purchaseMonth] = { hardware: 0, switch_physical: 0, switch_digital: 0, steam: 0, epic: 0, ubi: 0, ms: 0, emulator: 0, playtime: 0 }; trends[purchaseMonth].playtime += (item.playTime || 0); } } }); 
            const sortedMonths = Array.from(allMonths).sort(); 
            const datasets = [ { label: 'ç¡¬ä»¶', data: sortedMonths.map(m => trends[m]?.hardware || 0), backgroundColor: PLATFORM_COLORS.hardware, yAxisID: 'y', order: 2 }, { label: 'Switch å®ä½“', data: sortedMonths.map(m => trends[m]?.switch_physical || 0), backgroundColor: PLATFORM_COLORS.switch_physical, yAxisID: 'y', order: 2 }, { label: 'Switch æ•°å­—', data: sortedMonths.map(m => trends[m]?.switch_digital || 0), backgroundColor: PLATFORM_COLORS.switch_digital, yAxisID: 'y', order: 2 }, { label: 'Steam', data: sortedMonths.map(m => trends[m]?.steam || 0), backgroundColor: PLATFORM_COLORS.steam, yAxisID: 'y', order: 2 }, { label: 'Epic', data: sortedMonths.map(m => trends[m]?.epic || 0), backgroundColor: PLATFORM_COLORS.epic, yAxisID: 'y', order: 2 }, { label: 'Uplay', data: sortedMonths.map(m => trends[m]?.ubi || 0), backgroundColor: PLATFORM_COLORS.ubi, yAxisID: 'y', order: 2 }, { label: 'MS', data: sortedMonths.map(m => trends[m]?.ms || 0), backgroundColor: PLATFORM_COLORS.ms, yAxisID: 'y', order: 2 }, { label: 'æ¨¡æ‹Ÿå™¨', data: sortedMonths.map(m => trends[m]?.emulator || 0), backgroundColor: PLATFORM_COLORS.emulator, yAxisID: 'y', order: 2 }, { label: 'æ—¶é•¿', data: sortedMonths.map(m => trends[m]?.playtime || 0), borderColor: '#eab308', backgroundColor: '#eab308', type: 'line', tension: 0.3, yAxisID: 'y1', order: 1 } ]; 
            
            const el = document.getElementById(canvasId); if (!el) return;

            if (isFullscreen) {
                const minBarWidth = 40;
                const container = el.parentElement.parentElement;
                if (container) {
                    const chartWidth = Math.max(container.clientWidth, sortedMonths.length * minBarWidth);
                    el.parentElement.style.width = `${chartWidth}px`;
                }
            } else {
                if (el && el.parentElement) {
                    el.parentElement.style.width = '';
                }
            }
            
            if (charts[chartKey]) charts[chartKey].destroy(); 
            
            const chartOptions = {
                indexAxis: 'x', 
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: { 
                    x: { stacked: true, ticks: { callback: (v, i) => sortedMonths[v] ? sortedMonths[v].substring(2).replace('-', '/') : '' } },
                    y: { stacked: true, position: 'left', title: { display: true, text: 'æ”¯å‡º (Â¥)' }, grid: { color: 'rgba(107, 114, 128, 0.5)' }, beginAtZero: true },
                    y1: { position: 'right', title: { display: true, text: 'æ—¶é•¿ (h)' }, grid: { drawOnChartArea: false }, beginAtZero: true }
                },
                plugins: { tooltip: { enabled: false, external: createExternalTooltip((tooltip) => { if (!tooltip || !tooltip.body) return null; const month = tooltip.title?.[0]; if (!month) return null; const topCostItems = items.filter(i => normalizeMonth(i.purchaseDate) === month).map(i => ({ name: i.name, value: (i.purchasePrice || 0) - (i.sellPrice || 0) })).filter(i => i.value > 0).sort((a, b) => b.value - a.value).slice(0, 5); const topTimeItems = items.filter(item => { if (!item.playTime || item.playTime <= 0) return false; const itemMonth = normalizeMonth(item.purchaseDate); if (!itemMonth) return false; if (item.status !== 'passed' || !item.passDate) { return itemMonth === month; } const start = new Date(item.purchaseDate); const end = new Date(item.passDate); const currentMonthStart = new Date(month + '-01'); const currentMonthEnd = new Date(currentMonthStart.getFullYear(), currentMonthStart.getMonth() + 1, 0); return start <= currentMonthEnd && end >= currentMonthStart; }).sort((a, b) => (b.playTime || 0) - (a.playTime || 0)).slice(0, 5); let innerHtml = `<div class="font-bold text-base mb-2 border-b border-gray-600 pb-1">${month} æœˆæŠ¥</div>`; innerHtml += `<h4 class="font-semibold mt-2 mb-1">å½“æœˆæ”¯å‡º Top 5</h4><ul class="text-sm">`; topCostItems.forEach(item => { innerHtml += `<li class="flex justify-between my-1"><span>${((item.name || '') || '').substring(0, 20)}</span><strong>${formatCurrency(item.value)}</strong></li>`; }); if (topCostItems.length === 0) innerHtml += '<li>æ— æ”¯å‡ºè®°å½•</li>'; innerHtml += '</ul>'; innerHtml += `<h4 class="font-semibold mt-2 mb-1">å½“æœˆæ¸¸ç© Top 5</h4><ul class="text-sm">`; topTimeItems.forEach(item => { innerHtml += `<li class="flex justify-between my-1"><span>${((item.name) || '').substring(0, 15)}</span><span class="flex items-center"><strong>${(item.playTime || 0).toFixed(1)}h</strong>${renderStars(item.rating)}</span></li>`; }); if (topTimeItems.length === 0) innerHtml += '<li>æ— æ¸¸ç©è®°å½•</li>'; innerHtml += '</ul>'; return innerHtml; }) } }
            };

            charts[chartKey] = new Chart(el, { type: 'bar', data: { labels: sortedMonths, datasets: datasets }, options: chartOptions });
        };
        const updateKpiTooltips = () => { const games = items.filter(i => i.type !== 'hardware'); const topCost = [...games].sort((a,b) => ((b.purchasePrice || 0) - (b.sellPrice || 0)) - ((a.purchasePrice || 0) - (a.sellPrice || 0))).slice(0, 10); elements.gameCostTooltip.innerHTML = `<h3 class="font-bold mb-1">æ¸¸æˆæ”¯å‡º Top 10</h3><ul>` + topCost.map(g => `<li class="flex justify-between"><span>${g.name.substring(0,18)}</span><strong>${formatCurrency((g.purchasePrice||0)-(g.sellPrice||0))}</strong></li>`).join('') + '</ul>'; const topPlay = [...games].sort((a, b) => (b.playTime || 0) - (a.playTime || 0)).slice(0, 10); elements.playtimeTooltip.innerHTML = `<h3 class="font-bold mb-1">æ¸¸ç©æ—¶é•¿ Top 10</h3><ul>` + topPlay.map(g => `<li class="flex justify-between"><span>${g.name.substring(0,18)}</span><strong>${(g.playTime||0).toFixed(1)}h</strong></li>`).join('') + '</ul>'; const gamesCph = games.filter(g => g.playTime > 0 && g.from !== 'free').map(g => ({...g, cph: ((g.purchasePrice || 0) - (g.sellPrice || 0)) / g.playTime })); const cheapest = [...gamesCph].sort((a,b) => a.cph - b.cph).slice(0, 5); const mostExpensive = [...gamesCph].sort((a,b) => b.cph - a.cph).slice(0, 5); elements.cphTooltip.innerHTML = `<h3 class="font-bold mb-1">æœ€é«˜æ—¶é—´æˆæœ¬ Top 5</h3><ul>` + mostExpensive.map(g => `<li class="flex justify-between"><span>${g.name.substring(0,20)}</span><strong>${formatCurrency(g.cph)}/h</strong></li>`).join('') + `</ul><h3 class="font-bold mt-2 mb-1">æœ€ä½æ—¶é—´æˆæœ¬ Top 5</h3><ul>` + cheapest.map(g => `<li class="flex justify-between"><span>${g.name.substring(0,20)}</span><strong>${formatCurrency(g.cph)}/h</strong></li>`).join('') + '</ul>'; const unfinishedGames = items.filter(g => g.type !== 'hardware' && g.status !== 'passed'); const unfinishedPhysicalCost = unfinishedGames.filter(g => g.type === 'physical').reduce((s, i) => s + (i.purchasePrice || 0) - (i.sellPrice || 0), 0); const unfinishedDigitalCost = unfinishedGames.filter(g => !['physical', 'hardware'].includes(g.type)).reduce((s, i) => s + (i.purchasePrice || 0) - (i.sellPrice || 0), 0); const topUnfinished = [...unfinishedGames].sort((a,b) => ((b.purchasePrice || 0) - (b.sellPrice || 0)) - ((a.purchasePrice || 0) - (a.sellPrice || 0))).slice(0,5); let unfinishedHtml = `<div class="grid grid-cols-2 gap-1 mb-2"><div>å®ä½“: <strong>${formatCurrency(unfinishedPhysicalCost)}</strong></div><div>æ•°å­—: <strong>${formatCurrency(unfinishedDigitalCost)}</strong></div></div><h3 class="font-bold mt-2 mb-1 border-t border-gray-600 pt-1">æœ€è´µæœªé€šå…³ Top 5</h3><ul>`; unfinishedHtml += topUnfinished.map(g => `<li class="flex justify-between"><span>${g.name.substring(0,20)}</span><strong>${formatCurrency((g.purchasePrice||0)-(g.sellPrice||0))}</strong></li>`).join(''); if (topUnfinished.length === 0) unfinishedHtml += '<li>æ— </li>'; unfinishedHtml += '</ul>'; elements.unfinishedCostTooltip.innerHTML = unfinishedHtml; const gameCountByType = { 'Switch': items.filter(i => ['physical', 'digital'].includes(i.type)).length, 'Steam': items.filter(i => i.type === 'steam').length, 'Epic': items.filter(i => i.type === 'epic').length, 'Uplay': items.filter(i => i.type === 'ubi').length, 'MS Store': items.filter(i => i.type === 'ms').length, 'æ¨¡æ‹Ÿå™¨': items.filter(i => i.type === 'emulator').length, }; let gameCountHtml = `<h3 class="font-bold mb-1">å„å¹³å°æ¸¸æˆæ•°é‡</h3><ul>`; Object.entries(gameCountByType).forEach(([platform, count]) => { if (count > 0) gameCountHtml += `<li class="flex justify-between"><span>${platform}</span><strong>${count} æ¬¾</strong></li>`; }); gameCountHtml += '</ul>'; elements.totalGamesTooltip.innerHTML = gameCountHtml; };
        const updateDashboard = () => { const games = items.filter(i => i.type !== 'hardware'); const hardware = items.filter(i => i.type === 'hardware'); const gamesForCostCalc = games.filter(g => g.from !== 'free'); const totalActual = items.reduce((s, i) => s + (i.purchasePrice || 0) - (i.sellPrice || 0), 0); const gameActual = games.reduce((s, i) => s + (i.purchasePrice || 0) - (i.sellPrice || 0), 0); const hardwareActual = hardware.reduce((s, i) => s + (i.purchasePrice || 0) - (i.sellPrice || 0), 0); const unfinishedGamesCost = games.filter(g => g.status !== 'passed').reduce((s, i) => s + (i.purchasePrice || 0) - (i.sellPrice || 0), 0); const totalPlaytime = games.reduce((s, i) => s + (i.playTime || 0), 0); const gameCount = games.length; const avgPlaytime = gameCount > 0 ? totalPlaytime / gameCount : 0; const gameActualForCost = gamesForCostCalc.reduce((s, i) => s + (i.purchasePrice || 0) - (i.sellPrice || 0), 0); const totalPlaytimeForCost = gamesForCostCalc.reduce((s, i) => s + (i.playTime || 0), 0); const costPerHour = totalPlaytimeForCost > 0 ? gameActualForCost / totalPlaytimeForCost : null; elements.totalActualCost.textContent = formatCurrency(totalActual); elements.gameActualCost.textContent = formatCurrency(gameActual); elements.hardwareActualCost.textContent = formatCurrency(hardwareActual); elements.unfinishedGamesCost.textContent = formatCurrency(unfinishedGamesCost); elements.totalGames.textContent = `${gameCount} æ¬¾`; elements.totalPlaytime.textContent = `${totalPlaytime.toFixed(2)} å°æ—¶`; elements.avgPlaytime.textContent = `${avgPlaytime.toFixed(2)} å°æ—¶/æ¬¾`; elements.costPerHour.textContent = costPerHour !== null ? formatCurrency(costPerHour) : '/'; renderCharts(); updateKpiTooltips(); };
        const updateSortHeaders = () => { document.querySelectorAll('.sortable-header').forEach(header => { const key = header.dataset.sort; let text = header.textContent.replace(/[â–¾â–´]/, '').trim(); if (key === sortConfig.key) { header.textContent = `${text} ${sortConfig.direction === 'desc' ? 'â–¾' : 'â–´'}`; } else { header.textContent = text; } }); };
        const renderItemsList = () => { elements.itemsTableBody.innerHTML = ''; if (items.length === 0) return elements.noDataListMessage.classList.remove('hidden'); elements.noDataListMessage.classList.add('hidden'); const typeMap = { 'digital': 'Switchæ•°å­—', 'physical': 'Switchå®ä½“', 'hardware': 'ç¡¬ä»¶', 'steam': 'Steam', 'epic': 'Epic', 'ubi': 'Uplay', 'ms': 'MS Store', 'emulator': 'æ¨¡æ‹Ÿå™¨æ¸¸æˆ' }; const fromMap = { 'purchase': 'è´­ä¹°', 'free': 'å…è´¹', 'friend': 'èµ é€' }; const statusMap = {'playing': 'æ­£åœ¨ç©', 'backlog': 'å¾…ç©', 'passed': 'å·²é€šå…³', 'abandoned': 'å·²å¼ƒå‘', 'empty': 'ç©º'}; [...items].sort((a, b) => { const getVal = (item, key) => { const cost = (item.purchasePrice || 0) - (item.sellPrice || 0); switch(key) { case 'id': return item.id || ''; case 'name': return item.name || ''; case 'sort': return item.sort || ''; case 'type': return item.type || ''; case 'from': return item.from || ''; case 'status': return item.status || ''; case 'purchaseDate': return item.purchaseDate || ''; case 'purchasePrice': return item.purchasePrice ?? -1; case 'actualCost': return cost; case 'playTime': return item.playTime ?? -1; case 'costPerHour': return (!item.playTime || item.playTime <= 0 ? Infinity : cost / item.playTime); case 'rating': return item.rating ?? 0; case 'passDate': return item.passDate || ''; default: return ''; } }; const valA = getVal(a, sortConfig.key); const valB = getVal(b, sortConfig.key); const comparison = typeof valA === 'string' ? valA.localeCompare(valB, 'zh-CN') : (valA < valB ? -1 : (valA > valB ? 1 : 0)); return sortConfig.direction === 'asc' ? comparison : -comparison; }).forEach(item => { const cost = (item.purchasePrice || 0) - (item.sellPrice || 0); const cph = item.playTime > 0 ? cost / item.playTime : null; const row = document.createElement('tr'); row.className = 'border-b border-gray-600 hover:bg-gray-600 cursor-pointer'; row.dataset.fb_id = item.fb_id; row.innerHTML = `<td class="px-4 py-3 font-mono">${item.id}</td> <td class="px-4 py-3 font-medium whitespace-nowrap">${item.name}</td> <td class="px-4 py-3 whitespace-nowrap">${item.sort || '/'}</td> <td class="px-4 py-3">${typeMap[item.type] || item.type}</td><td class="px-4 py-3">${fromMap[item.from] || 'è´­ä¹°'}</td><td class="px-4 py-3">${statusMap[item.status] || 'å¾…ç©'}</td> <td class="px-4 py-3">${item.purchaseDate || '/'}</td> <td class="px-4 py-3">${item.purchasePrice != null ? formatCurrency(item.purchasePrice) : '/'}</td> <td class="px-4 py-3">${formatCurrency(cost)}</td> <td class="px-4 py-3">${item.playTime != null ? `${item.playTime}h` : '/'}</td> <td class="px-4 py-3">${cph != null && isFinite(cph) ? formatCurrency(cph) : '/'}</td><td class="px-4 py-3 text-center">${renderStarsForTable(item.rating)}</td> <td class="px-4 py-3">${item.passDate || ''}</td>`; row.addEventListener('click', () => handleEditItem(item.fb_id)); elements.itemsTableBody.appendChild(row); }); };
        
        const handleEditItem = (fb_id) => { 
            if(!ADMIN_UIDS.includes(userId)) return; 
            const item = items.find(i => i.fb_id === fb_id); if (!item) return; isEditingFromList = true; elements.modalTitle.textContent = 'ç¼–è¾‘è®°å½•'; elements.itemForm.reset(); elements.itemId.value = item.fb_id; elements.itemCustomId.value = item.id || ''; elements.itemName.value = item.name; elements.itemSort.value = item.sort || ''; elements.itemType.value = item.type; elements.itemFrom.value = item.from || 'purchase'; elements.purchaseDate.value = item.purchaseDate || ''; elements.purchasePrice.value = item.purchasePrice || ''; elements.playTime.value = item.playTime || ''; elements.itemStatus.value = item.status || 'playing'; elements.passDate.value = item.passDate || ''; elements.sellDate.value = item.sellDate || ''; elements.sellPrice.value = item.sellPrice || ''; elements.itemRating.value = item.rating || ''; elements.passDateContainer.classList.toggle('hidden', elements.itemStatus.value !== 'passed'); elements.deleteBtn.classList.remove('hidden'); closeModal(elements.listModal); openModal(elements.itemModal); 
        };
        
        const showOnThisDay = () => {
            const today = new Date();
            const currentYear = today.getFullYear();

            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 3);
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 3);

            const startMonth = startDate.getMonth();
            const endMonth = endDate.getMonth();
            const targetMonths = Array.from(new Set([startMonth, endMonth]));

            const gamesByYear = {};

            items.forEach(item => {
                if (item.type !== 'hardware' && item.purchaseDate) {
                    const purchaseDate = new Date(item.purchaseDate);
                    if (!isNaN(purchaseDate.getTime())) {
                        const purchaseMonth = purchaseDate.getMonth();
                        const purchaseYear = purchaseDate.getFullYear();
                        if (purchaseYear < currentYear && targetMonths.includes(purchaseMonth)) {
                            if (!gamesByYear[purchaseYear]) {
                                gamesByYear[purchaseYear] = [];
                            }
                            gamesByYear[purchaseYear].push(item);
                        }
                    }
                }
            });

            let htmlContent = '';
            const sortedYears = Object.keys(gamesByYear).sort((a, b) => b - a);

            if (sortedYears.length === 0) {
                htmlContent = '<p class="text-center text-gray-400">åœ¨è¿‡å»çš„è¿™æ®µæ—¶é—´é‡Œï¼Œä¼¼ä¹æ²¡æœ‰ç•™ä¸‹æ¸¸æˆè¶³è¿¹å“¦ã€‚</p>';
            } else {
                let monthString = (startMonth === endMonth) ? `${startMonth + 1}æœˆ` : `${startMonth + 1}æœˆ - ${endMonth + 1}æœˆ`;
                
                sortedYears.forEach(year => {
                    const topGames = gamesByYear[year].sort((a, b) => (b.playTime || 0) - (a.playTime || 0)).slice(0, 5);
                    if (topGames.length > 0) {
                        const gameListHtml = topGames.map(g => `<p class="text-xl font-bold text-white truncate">${g.name}</p>`).join('');
                        htmlContent += `<div class="py-3 border-b border-gray-700 last:border-b-0"><p class="text-gray-400">${year}å¹´ ${monthString}ï¼Œä½ å¯èƒ½åœ¨ç©ï¼š</p><div class="mt-2 space-y-1">${gameListHtml}</div></div>`;
                    }
                });
            }

            if (htmlContent === '') {
                 htmlContent = '<p class="text-center text-gray-400">åœ¨è¿‡å»çš„è¿™æ®µæ—¶é—´é‡Œï¼Œä¼¼ä¹æ²¡æœ‰ç•™ä¸‹æ¸¸æˆè¶³è¿¹å“¦ã€‚</p>';
            }

            elements.onThisDayContent.innerHTML = htmlContent;
            openModal(elements.onThisDayModal);
        };
        
        async function getAIRecommendations(customPrompt = '') {
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            const recentHistory = items
                .filter(i => i.status === 'passed' && i.passDate && new Date(i.passDate) >= threeMonthsAgo)
                .map(i => `- ã€Š${i.name}ã€‹: æ¸¸ç© ${i.playTime || 0} å°æ—¶, è¯„åˆ† ${i.rating || 'æœª'}/5`)
                .join('\n');

            const backlog = items
                .filter(i => i.status === 'backlog')
                .map(i => `ã€Š${i.name}ã€‹`)
                .join(', ');

            if (backlog.length === 0 && !customPrompt) {
                 return { recommendations: [{name: "å¤ªæ£’äº†ï¼", reason: "æ‚¨çš„å¾…ç©æ¸…å•å·²ç»ä¸€å¹²äºŒå‡€ï¼Œæ˜¯æ—¶å€™è´­å…¥æ–°æ¸¸æˆäº†ï¼"}] };
            }

            try {
                const getRecommendationsFunction = httpsCallable(functions, 'getAiRecommendations');
                const result = await getRecommendationsFunction({ recentHistory, backlog, customPrompt });

                const data = result.data;
                if (!data || !data.output || !data.output.text) {
                     throw new Error("ä»äº‘å‡½æ•°è¿”å›çš„å“åº”ç»“æ„æ— æ•ˆã€‚");
                }
                
                const recommendationsText = data.output.text;

                try {
                    const recommendations = JSON.parse(recommendationsText);
                    if (Array.isArray(recommendations) && recommendations.every(r => r.name && r.reason)) {
                        return { recommendations };
                    } else {
                         throw new Error("è§£æåçš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„æ¨èæ•°ç»„ã€‚");
                    }
                } catch (e) {
                    console.error("æ— æ³•å°†AIå“åº”è§£æä¸ºJSON:", recommendationsText, e);
                    return { error: "AIè¿”å›çš„æ ¼å¼ä¸æ­£ç¡®ï¼Œæ— æ³•è§£ææ¨èå†…å®¹ã€‚" };
                }

            } catch (error) {
                console.error("è°ƒç”¨Cloud Functionæ—¶å‡ºé”™:", error);
                let errorMessage = "è°ƒç”¨AIæœåŠ¡æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚";
                if (error.code === 'unavailable') {
                    errorMessage = "æ— æ³•è¿æ¥åˆ°AIæœåŠ¡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚";
                } else if (error.message) {
                    errorMessage = `è°ƒç”¨AIæœåŠ¡å¤±è´¥: ${error.message}`;
                }
                return { error: errorMessage };
            }
        }
    
        const setupEventListeners = () => { 
            elements.loginBtn.addEventListener('click', signInWithGoogle);
            elements.logoutBtn.addEventListener('click', signOutUser);
            elements.viewAllBtn.addEventListener('click', () => { 
                elements.listModalTitle.textContent = "æ•°æ®è¯¦æƒ…";
                elements.listSearchInput.value = '';
                sortConfig = { key: 'id', direction: 'desc' }; 
                renderItemsList(); 
                updateSortHeaders(); 
                openModal(elements.listModal); 
            }); 
            elements.onThisDayBtn.addEventListener('click', showOnThisDay);
            elements.closeOnThisDayModalBtn.addEventListener('click', () => closeModal(elements.onThisDayModal));
            elements.closePlayNextModalBtn.addEventListener('click', () => closeModal(elements.playNextModal));
            
            elements.playNextBtn.addEventListener('click', () => {
                const myPlayNextGames = items.filter(i => i.status === 'backlog');
                elements.myPlayNextList.innerHTML = myPlayNextGames.length > 0 
                    ? myPlayNextGames.map(g => `<p class="p-3 bg-gray-800/80 rounded-md font-semibold ring-1 ring-gray-700">${g.name}</p>`).join('')
                    : '<p class="text-gray-500 text-center">ä½ è¿˜æœªæ ‡è®°ä»»ä½•å¾…ç©çš„æ¸¸æˆã€‚</p>';
                
                elements.aiPromptInput.value = '';
                elements.aiRecommendationsList.innerHTML = '<p class="text-gray-500 text-center">è¾“å…¥æ‚¨æƒ³ç©çš„é£æ ¼ï¼Œè®©AIä¸ºæ‚¨æ¨èã€‚</p>';
                openModal(elements.playNextModal);
            });

            elements.aiPromptSendBtn.addEventListener('click', async () => {
                const customPrompt = elements.aiPromptInput.value;
                elements.aiRecommendationsList.innerHTML = '<div class="flex justify-center items-center h-full"><p class="text-gray-500 animate-pulse">ğŸ¤– æ­£åœ¨å‘AIå’¨è¯¢ä¸­ï¼Œè¯·ç¨å€™...</p></div>';

                const result = await getAIRecommendations(customPrompt);
                
                if (result.error) {
                    elements.aiRecommendationsList.innerHTML = `<div class="p-4 bg-red-900/50 rounded-lg text-red-400 text-center">${result.error}</div>`;
                } else if (result.recommendations && result.recommendations.length > 0) {
                    elements.aiRecommendationsList.innerHTML = result.recommendations
                        .map(rec => `<div class="p-3 bg-gray-700/80 rounded-md ring-1 ring-gray-600"><h4 class="font-bold text-white text-md">${rec.name}</h4><p class="text-gray-300 mt-1 text-sm">${rec.reason}</p></div>`).join('');
                } else {
                    elements.aiRecommendationsList.innerHTML = '<p class="text-gray-500 text-center">AIæš‚æ—¶æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ¨èã€‚</p>';
                }
            });


            elements.addItemFab.addEventListener('click', () => {
                if (elements.fabContainer.classList.contains('open')) {
                    isEditingFromList = false;
                    elements.modalTitle.textContent = 'æ·»åŠ è®°å½•';
                    elements.itemForm.reset();
                    elements.itemId.value = '';
                    elements.itemCustomId.value = '';
                    elements.deleteBtn.classList.add('hidden');
                    elements.purchaseDate.value = new Date().toISOString().split('T')[0];
                    elements.itemStatus.value = 'playing'; // é»˜è®¤çŠ¶æ€
                    elements.passDateContainer.classList.add('hidden');
                    openModal(elements.itemModal);
                    elements.fabContainer.classList.remove('open');
                } else {
                    elements.fabContainer.classList.add('open');
                }
            });

            document.addEventListener('click', (e) => {
                if (!elements.fabContainer.contains(e.target) && elements.fabContainer.classList.contains('open')) {
                    elements.fabContainer.classList.remove('open');
                }
            });

            elements.itemForm.addEventListener('submit', async (e) => { e.preventDefault(); const fb_id = elements.itemId.value; const status = elements.itemStatus.value; const itemData = { id: elements.itemCustomId.value, name: elements.itemName.value, sort: elements.itemSort.value, type: elements.itemType.value, from: elements.itemFrom.value, purchaseDate: parseDateOrNull(elements.purchaseDate.value), purchasePrice: parseFloatOrNull(elements.purchasePrice.value), playTime: parseFloatOrNull(elements.playTime.value), status: status, passDate: status === 'passed' ? parseDateOrNull(elements.passDate.value) : null, sellDate: parseDateOrNull(elements.sellDate.value), sellPrice: parseFloatOrNull(elements.sellPrice.value), rating: parseFloatOrNull(elements.itemRating.value), }; try { const docRef = fb_id ? doc(itemsCollectionRef, fb_id) : doc(itemsCollectionRef); await setDoc(docRef, itemData, { merge: true }); await updateLastModifiedTimestamp(); closeItemModalAndReturnToList(); } catch (error) { console.error("Error saving item: ", error); } });
            elements.deleteBtn.addEventListener('click', () => { showConfirmation('æ‚¨ç¡®å®šè¦åˆ é™¤æ­¤è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚', async () => { const fb_id = elements.itemId.value; try { await deleteDoc(doc(itemsCollectionRef, fb_id)); await updateLastModifiedTimestamp(); closeItemModalAndReturnToList(); } catch (error) { console.error("Error deleting item: ", error); } }); });
            elements.importBtn.addEventListener('click', () => elements.csvImportInput.click()); 
            elements.exportBtn.addEventListener('click', () => { if (items.length === 0) { showConfirmation('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºã€‚', () => {}); document.getElementById('confirm-ok-btn').classList.add('hidden'); document.getElementById('confirm-modal-title').textContent = "é€šçŸ¥"; return; } const headers = ['id', 'name', 'type', 'sort', 'status', 'purchaseDate', 'purchasePrice', 'from', 'playTime', 'passDate', 'sellDate', 'sellPrice', 'rating']; const csv = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(',') + '\r\n' + items.map(i => headers.map(h => `"${i[h] ?? ''}"`).join(',')).join('\r\n'); const link = Object.assign(document.createElement("a"), { href: encodeURI(csv), download: `game_cost_export_${new Date().toISOString().split('T')[0]}.csv` }); document.body.appendChild(link); link.click(); document.body.removeChild(link); }); 
            elements.csvImportInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; showConfirmation('å¯¼å…¥CSVå°†è¦†ç›–æ‰€æœ‰ç°æœ‰æ•°æ®ï¼Œæ‚¨ç¡®å®šå—ï¼Ÿ', async () => { const reader = new FileReader(); reader.onload = async (re) => { const text = re.target.result; if (!text) { showConfirmation('æ–‡ä»¶ä¸ºç©ºæˆ–æ— æ³•è¯»å–ã€‚', () => {}); document.getElementById('confirm-ok-btn').classList.add('hidden'); document.getElementById('confirm-modal-title').textContent = "é”™è¯¯"; return; } const rows = text.split(/\r\n|\n/); const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, '')); try { const headerIndexMap = {}; headers.forEach((h, i) => { headerIndexMap[h] = i; }); if (headerIndexMap['id'] === undefined || headerIndexMap['name'] === undefined || headerIndexMap['type'] === undefined) { showConfirmation('å¯¼å…¥å¤±è´¥ï¼šCSVæ–‡ä»¶å¿…é¡»åŒ…å« id, name, å’Œ type è¡¨å¤´ã€‚', () => {}); document.getElementById('confirm-ok-btn').classList.add('hidden'); document.getElementById('confirm-modal-title').textContent = "é”™è¯¯"; return; } const newItems = rows.slice(1).filter(r => r.trim()).map(r => { const v = r.split(',').map(val => val.trim().replace(/^"|"$/g, '')); const getVal = (headerName) => v[headerIndexMap[headerName]] || ''; const item = { id: getVal('id'), name: getVal('name'), sort: getVal('sort'), type: getVal('type'), from: getVal('from'), status: getVal('status') || 'empty', purchaseDate: parseDateOrNull(getVal('purchaseDate')), purchasePrice: parseFloatOrNull(getVal('purchasePrice')), passDate: parseDateOrNull(getVal('passDate')), sellDate: parseDateOrNull(getVal('sellDate')), sellPrice: parseFloatOrNull(getVal('sellPrice')), playTime: parseFloatOrNull(headerIndexMap['playTime'] !== undefined ? getVal('playTime') : getVal('time')), rating: parseFloatOrNull(getVal('rating')) }; return (!item.id || !item.name || !item.type) ? null : item; }).filter(Boolean); if (new Set(newItems.map(i => i.id)).size !== newItems.length) { showConfirmation('å¯¼å…¥å¤±è´¥ï¼šIDé‡å¤ã€‚', () => {}); document.getElementById('confirm-ok-btn').classList.add('hidden'); document.getElementById('confirm-modal-title').textContent = "é”™è¯¯"; return; } const querySnapshot = await getDocs(query(itemsCollectionRef)); const batch = writeBatch(db); querySnapshot.forEach((doc) => { batch.delete(doc.ref); }); newItems.forEach((item) => { const newDocRef = doc(itemsCollectionRef); batch.set(newDocRef, item); }); await batch.commit(); await updateLastModifiedTimestamp(); showConfirmation('å¯¼å…¥æˆåŠŸï¼', () => {}); document.getElementById('confirm-ok-btn').classList.add('hidden'); document.getElementById('confirm-modal-title').textContent = "æˆåŠŸ"; } catch (error) { console.error(error); showConfirmation('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼æˆ–æ§åˆ¶å°æ—¥å¿—ã€‚', () => {}); document.getElementById('confirm-ok-btn').classList.add('hidden'); document.getElementById('confirm-modal-title').textContent = "é”™è¯¯"; } }; reader.readAsText(file, 'UTF-8'); }); e.target.value = null; }); 
            
            elements.closeModalBtn.addEventListener('click', () => closeItemModalAndReturnToList()); 
            elements.cancelBtn.addEventListener('click', () => closeItemModalAndReturnToList()); 
            elements.closeListModalBtn.addEventListener('click', () => closeModal(elements.listModal));
            elements.confirmCancelBtn.addEventListener('click', () => closeModal(elements.confirmModal));
            elements.excludeHardwareCheckbox.addEventListener('change', () => renderMonthlyTrendsChart());

            elements.itemStatus.addEventListener('change', (e) => {
                elements.passDateContainer.classList.toggle('hidden', e.target.value !== 'passed');
            });

            elements.itemType.addEventListener('change', () => {
                if (!elements.itemId.value && !elements.itemCustomId.value) {
                    elements.itemCustomId.value = `${elements.itemType.value.charAt(0)}-${Date.now().toString().slice(-8)}`;
                }
            });

            const setDistButtonActive = (activeBtn) => {
                [elements.distTimeBtn, elements.distPriceBtn].forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('text-gray-300', 'hover:bg-gray-600');
                });
                activeBtn.classList.add('bg-indigo-600', 'text-white');
                activeBtn.classList.remove('text-gray-300', 'hover:bg-gray-600');
            };

            elements.distTimeBtn.addEventListener('click', () => {
                if(gameDistributionMode === 'time') return;
                gameDistributionMode = 'time';
                setDistButtonActive(elements.distTimeBtn);
                renderGameDistributionChart();
            });

            elements.distPriceBtn.addEventListener('click', () => {
                if(gameDistributionMode === 'price') return;
                gameDistributionMode = 'price';
                setDistButtonActive(elements.distPriceBtn);
                renderGameDistributionChart();
            });

            elements.monthlyChartFullscreenBtn.addEventListener('click', () => {
                openModal(elements.monthlyChartFullscreenModal);
                renderMonthlyTrendsChart(true);
            });
            elements.closeMonthlyChartFullscreenBtn.addEventListener('click', () => {
                closeModal(elements.monthlyChartFullscreenModal);
                if (charts.monthlyTrendsFullscreen) {
                    charts.monthlyTrendsFullscreen.destroy();
                    delete charts.monthlyTrendsFullscreen;
                }
            });

            elements.listSearchInput.addEventListener('keyup', () => {
                const searchTerm = elements.listSearchInput.value.toLowerCase();
                const rows = elements.itemsTableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const rowText = row.textContent.toLowerCase();
                    row.style.display = rowText.includes(searchTerm) ? '' : 'none';
                });
            });

            document.querySelectorAll('.sortable-header').forEach(header => { header.addEventListener('click', () => { const sortKey = header.dataset.sort; if (sortConfig.key === sortKey) { sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc'; } else { sortConfig.key = sortKey; sortConfig.direction = 'desc'; } renderItemsList(); updateSortHeaders(); }); }); };
        
        // --- App Initialization ---
        const initApp = () => {
            updateUIAccess(null);
            setupChartDefaults();
            setupEventListeners();
            setupFirestoreListener(); 
            setupMetadataListener();
            document.querySelectorAll('.card-animation').forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, (index + 1) * 100);
            });
        };
    
        // --- Authentication and UI Control Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                elements.userAvatar.src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'A')}&background=random`;
                elements.loginBtn.classList.add('hidden');
                elements.userInfo.classList.remove('hidden');
                elements.userInfo.classList.add('flex');
                updateUIAccess(userId);
            } else {
                userId = null;
                elements.loginBtn.classList.remove('hidden');
                elements.userInfo.classList.add('hidden');
                elements.userInfo.classList.remove('flex');
                updateUIAccess(null);
            }
        });
        
        initApp();
    });
</script>

</body>
</html>
